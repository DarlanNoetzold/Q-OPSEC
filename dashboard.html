<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Q-OPSEC Orchestrator Dashboard</title>
  <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0d0f1a;
      color: #e5e7eb;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .app {
      flex-grow: 1;
      background: radial-gradient(1000px 600px at 10% 10%, #1c1f2e 0%, #0d0f1a 60%);
      display: flex;
      flex-direction: column;
    }
    .header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(13,15,26,0.85);
      backdrop-filter: saturate(180%) blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .brand h1 {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: 0.2px;
      background: linear-gradient(135deg, #8ab4ff, #86efac);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      user-select: none;
    }
    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background-color 0.2s ease, border-color 0.2s ease;
      color: #e5e7eb;
      user-select: none;
      white-space: nowrap;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn-green {
      background-color: #10b98133;
      border-color: #10b98166;
    }
    .btn-green:hover:not(:disabled) {
      background-color: #10b98155;
    }
    .btn-red {
      background-color: #ef444433;
      border-color: #ef444466;
    }
    .btn-red:hover:not(:disabled) {
      background-color: #ef444455;
    }
    .btn-ghost {
      background-color: transparent;
      border-color: #ffff33;
      color: #a5b4fc;
    }
    .btn-ghost:hover:not(:disabled) {
      background-color: #ffff1a;
      color: #e0e7ff;
    }
    .tabs {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 1.5rem;
      display: flex;
      gap: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      user-select: none;
    }
    .tab {
      background: transparent;
      border: none;
      color: #9ca3af;
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      font-weight: 700;
      font-size: 1rem;
      transition: color 0.15s ease, border-color 0.15s ease;
    }
    .tab:hover {
      color: #93c5fd;
    }
    .tab.active {
      color: #93c5fd;
      border-bottom-color: #93c5fd;
    }
    main.container {
      max-width: 1280px;
      margin: 1.5rem auto;
      padding: 0 1.5rem;
      flex-grow: 1;
      overflow-y: auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1rem;
    }
    .card {
      background: #111425;
      border: 1px solid #1f233a;
      border-radius: 0.75rem;
      padding: 1rem;
      transition: border-color 0.3s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .card:hover {
      border-color: #3b82f6;
    }
    .service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .service-name {
      font-weight: 700;
      font-size: 1.125rem;
      color: #e0e7ff;
    }
    .badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      border: 1px solid;
      user-select: none;
      white-space: nowrap;
    }
    .badge.ok {
      color: #10b981;
      background: #10b98133;
      border-color: #10b98155;
    }
    .badge.off {
      color: #6b7280;
      background: #6b728033;
      border-color: #6b728055;
    }
    .meta {
      font-size: 0.75rem;
      color: #9ca3af;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    .btn-sm {
      padding: 0.4rem 0.75rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      border: 1px solid #2a2f4a;
      background: #161a2f;
      color: #cbd5e1;
      transition: background-color 0.2s ease;
      cursor: pointer;
      user-select: none;
    }
    .btn-sm:hover:not(:disabled) {
      background: #1b2040;
    }
    .btn-sm:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .panel {
      background: #0f1328;
      border: 1px solid #1f233a;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-top: 1rem;
      overflow-x: auto;
    }
    .search {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .input, textarea {
      font-family: monospace;
      font-size: 0.9rem;
      background: #0b0e1f;
      border: 1px solid #242847;
      color: #e5e7eb;
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      width: 100%;
      resize: vertical;
      transition: border-color 0.2s ease;
    }
    .input:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px #3b82f633;
    }
    .trace-service {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background: #0d0f1a;
      border: 1px solid #242847;
    }
    .trace-match {
      margin-top: 0.75rem;
      padding: 0.5rem;
      border-left: 3px solid #3b82f6;
      background: #0b0e1f;
      border-radius: 0.375rem;
      font-family: monospace;
      font-size: 0.875rem;
      color: #d1d5db;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .mono {
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.875rem;
      color: #d1d5db;
    }
    .flow-step {
      display: flex;
      gap: 1rem;
      padding: 1rem;
      background: #0b0e1f;
      border: 1px solid #242847;
      border-radius: 0.5rem;
      align-items: center;
    }
    .flow-step + .flow-step {
      margin-top: 1rem;
    }
    .chip {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.2px;
      user-select: none;
      white-space: nowrap;
    }
    .chip.ok {
      color: #10b981;
      background: #10b98133;
      border: 1px solid #10b98155;
    }
    .chip.wait {
      color: #f59e0b;
      background: #f59e0b33;
      border: 1px solid #f59e0b55;
    }
    .chip.err {
      color: #ef4444;
      background: #ef444433;
      border: 1px solid #ef444455;
    }
    .ball {
      width: 40px;
      height: 40px;
      border-radius: 9999px;
      display: grid;
      place-items: center;
      background: #0d1022;
      border: 1px solid #242847;
      color: #9aa0b4;
      font-weight: 800;
      user-select: none;
    }
    .timeline-item {
      display: grid;
      grid-template-columns: 180px 200px 1fr;
      gap: 1rem;
      padding: 0.75rem;
      border-left: 3px solid #3b82f6;
      background: #0b0e1f;
      border: 1px solid #242847;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      color: #d1d5db;
      word-break: break-word;
    }
    .timeline-item + .timeline-item {
      margin-top: 0.5rem;
    }
    .logs {
      max-height: 60vh;
      overflow-y: auto;
      background: #0b0e1f;
      border: 1px solid #242847;
      border-radius: 0.5rem;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.875rem;
      color: #d1d5db;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .log {
      padding: 0.25rem 0;
      border-bottom: 1px dashed #1d2240;
    }
    .log:last-child {
      border-bottom: none;
    }
    .note {
      font-size: 0.75rem;
      color: #9ca3af;
      user-select: none;
    }
    .notif {
      position: fixed;
      right: 1rem;
      top: 1rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(0,0,0,0.35);
      border: 1px solid;
      user-select: none;
      z-index: 1000;
      max-width: 320px;
      word-break: break-word;
    }
    .notif.ok {
      background: #052e26;
      color: #86efac;
      border-color: #10b98155;
    }
    .notif.err {
      background: #3a0b0b;
      color: #fecaca;
      border-color: #ef444455;
    }
    .service-footer {
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.1);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .footer-link {
      font-size: 0.75rem;
      color: #3b82f6;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .footer-link:hover {
      text-decoration: underline;
      color: #60a5fa;
    }
    .footer-text {
      font-size: 0.7rem;
      color: #6b7280;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const SERVICES_WITH_METRICS = ['risk_service', 'confiability_service', 'classification_agent'];
    const SWAGGER_IP = '192.168.18.18';

    function ImageCarousel({ images, basePath }) {
      const [currentIndex, setCurrentIndex] = React.useState(0);

      if (!images || images.length === 0) {
        return <p>No images available.</p>;
      }

      const prev = () => {
        setCurrentIndex((currentIndex - 1 + images.length) % images.length);
      };

      const next = () => {
        setCurrentIndex((currentIndex + 1) % images.length);
      };

      const currentImage = images[currentIndex];
      const imageUrl = `${basePath}/${currentImage}`;

      return (
        <div style={{ textAlign: 'center' }}>
          <div style={{ marginBottom: '0.5rem' }}>
            <button className="btn btn-ghost" onClick={prev} aria-label="Previous image">‚Üê</button>
            <span style={{ margin: '0 1rem' }}>{currentIndex + 1} / {images.length}</span>
            <button className="btn btn-ghost" onClick={next} aria-label="Next image">‚Üí</button>
          </div>
          <img
            src={imageUrl}
            alt={currentImage}
            style={{ maxHeight: '400px', maxWidth: '100%', borderRadius: '0.5rem', cursor: 'pointer' }}
            onClick={() => window.open(imageUrl, '_blank')}
            tabIndex={0}
            onKeyDown={e => e.key === 'Enter' && window.open(imageUrl, '_blank')}
          />
        </div>
      );
    }

    function App() {
      const [services, setServices] = useState([]);
      const [activeTab, setActiveTab] = useState('services');
      const [loading, setLoading] = useState(false);
      const [notif, setNotif] = useState(null);

      const [selectedService, setSelectedService] = useState(null);
      const [logs, setLogs] = useState([]);

      const [requestId, setRequestId] = useState('');
      const [traceData, setTraceData] = useState(null);
      const [flowData, setFlowData] = useState(null);
      const [timelineData, setTimelineData] = useState(null);
      const [activeRequests, setActiveRequests] = useState([]);

      const [metricsService, setMetricsService] = useState(SERVICES_WITH_METRICS[0]);
      const [metricsSessions, setMetricsSessions] = useState([]);
      const [selectedSession, setSelectedSession] = useState(null);
      const [sessionImages, setSessionImages] = useState([]);

      const [datasetsService, setDatasetsService] = useState(SERVICES_WITH_METRICS[0]);
      const [datasets, setDatasets] = useState([]);
      const [selectedDataset, setSelectedDataset] = useState(null);
      const [datasetPreview, setDatasetPreview] = useState(null);

      const [serviceConfigs, setServiceConfigs] = useState({});

      const API = window.location.origin;

      const toast = (msg, type='ok') => {
        setNotif({ msg, type });
        setTimeout(() => setNotif(null), 3000);
      };

      const fetchServices = async () => {
        try {
          const r = await fetch(API + '/services');
          const data = await r.json();
          setServices(data);

          setServiceConfigs(prev => {
            const newConfigs = {...prev};
            for (const s of data) {
              if (!newConfigs[s.name]) {
                newConfigs[s.name] = {
                  start: s.start ? JSON.stringify(s.start, null, 2) : '[]',
                  cwd: s.cwd || ''
                };
              } else {
                if (!newConfigs[s.name].start || newConfigs[s.name].start === '[]') {
                  newConfigs[s.name].start = s.start ? JSON.stringify(s.start, null, 2) : '[]';
                }
                if (!newConfigs[s.name].cwd) {
                  newConfigs[s.name].cwd = s.cwd || '';
                }
              }
            }
            return newConfigs;
          });
        } catch (e) {
          toast('Failed to load services', 'err');
        }
      };

      useEffect(() => {
        fetchServices();
        const t = setInterval(fetchServices, 5000);
        return () => clearInterval(t);
      }, []);

      const startAll = async () => {
        setLoading(true);
        try { await fetch(API + '/start/all', { method: 'POST' }); toast('All started'); }
        catch { toast('Error starting all', 'err'); }
        setLoading(false); fetchServices();
      };

      const stopAll = async () => {
        setLoading(true);
        try { await fetch(API + '/stop/all', { method: 'POST' }); toast('All stopped'); }
        catch { toast('Error stopping all', 'err'); }
        setLoading(false); fetchServices();
      };

      const startService = async (name) => {
        setLoading(true);
        try { await fetch(`${API}/services/${name}/start`, { method: 'POST' }); toast(`${name} started`); }
        catch { toast(`Error starting ${name}`, 'err'); }
        setLoading(false); fetchServices();
      };

      const stopService = async (name) => {
        setLoading(true);
        try { await fetch(`${API}/services/${name}/stop`, { method: 'POST' }); toast(`${name} stopped`); }
        catch { toast(`Error stopping ${name}`, 'err'); }
        setLoading(false); fetchServices();
      };

      const restartService = async (name) => {
        setLoading(true);
        try { await fetch(`${API}/services/${name}/restart`, { method: 'POST' }); toast(`${name} restarted`); }
        catch { toast(`Error restarting ${name}`, 'err'); }
        setLoading(false); fetchServices();
      };

      const viewLogs = async (name) => {
        setActiveTab('logs');
        setSelectedService(name);
        try {
          const r = await fetch(`${API}/services/${name}/logs?lines=600`);
          const data = await r.json();
          setLogs(data.tail || []);
        } catch {
          toast(`Error loading logs for ${name}`, 'err');
        }
      };

      const onConfigChange = (serviceName, field, value) => {
        setServiceConfigs(prev => ({
          ...prev,
          [serviceName]: {
            ...prev[serviceName],
            [field]: value
          }
        }));
      };

      const saveServiceConfig = async (serviceName) => {
        if (!serviceConfigs[serviceName]) return;
        let startCmd;
        try {
          startCmd = JSON.parse(serviceConfigs[serviceName].start);
          if (!Array.isArray(startCmd)) throw new Error('Start command must be a JSON array');
        } catch (err) {
          return toast(`Invalid JSON in start command: ${err.message}`, 'err');
        }
        const payload = {
          start: startCmd,
          cwd: serviceConfigs[serviceName].cwd || undefined
        };
        try {
          const r = await fetch(`${API}/services/${serviceName}/config`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          if (r.ok) toast(`Config saved for ${serviceName}`);
          else toast(`Failed to save config for ${serviceName}`, 'err');
        } catch {
          toast(`Error saving config for ${serviceName}`, 'err');
        }
      };

      const doTrace = async () => {
        if (!requestId) return;
        setActiveTab('trace');
        try {
          const r = await fetch(`${API}/trace/${requestId}`);
          setTraceData(await r.json());
        } catch { toast('Trace error', 'err'); }
      };

      const loadFlow = async () => {
        if (!requestId) return;
        setActiveTab('flow');
        try {
          const r = await fetch(`${API}/flow/${requestId}`);
          setFlowData(await r.json());
        } catch { toast('Flow load error', 'err'); }
      };

      const loadTimeline = async () => {
        if (!requestId) return;
        setActiveTab('timeline');
        try {
          const r = await fetch(`${API}/timeline/${requestId}`);
          setTimelineData(await r.json());
        } catch { toast('Timeline load error', 'err'); }
      };

      const loadActiveReqs = async () => {
        setActiveTab('active');
        try {
          const r = await fetch(`${API}/requests/active`);
          const data = await r.json();
          setActiveRequests(data.active_request_ids || []);
        } catch { toast('Error listing requests', 'err'); }
      };

      useEffect(() => {
        if (activeTab === 'metrics' && metricsService) {
          loadMetricsSessions(metricsService);
        }
      }, [activeTab, metricsService]);

      const loadMetricsSessions = async (service) => {
        setSelectedSession(null);
        setSessionImages([]);
        try {
          const r = await fetch(`${API}/metrics/${service}/sessions`);
          if (!r.ok) throw new Error('Failed to fetch sessions');
          const data = await r.json();

          let sessions = [];
          if (service === 'classification_agent') {
            sessions = (data.sessions || []).map(s => ({ session_id: s }));
          } else {
            sessions = data.sessions || [];
          }

          setMetricsSessions(sessions);
        } catch {
          toast('Error loading metrics sessions', 'err');
          setMetricsSessions([]);
        }
      };

      const loadSessionDetail = async (service, session) => {
        const sessionId = typeof session === 'string' ? session : session.session_id;
        if (!sessionId || sessionId === 'undefined') {
          toast('Invalid session selected', 'err');
          return;
        }
        setSelectedSession(session);
        setSessionImages([]);

        try {
          const rSummary = await fetch(`${API}/metrics/${service}/sessions/${sessionId}`);
          if (!rSummary.ok) throw new Error('Failed to fetch session summary');
          const summaryData = await rSummary.json();

          if (service === 'classification_agent') {
            const rImages = await fetch(`${API}/metrics/${service}/images`);
            if (!rImages.ok) throw new Error('Failed to fetch available images');
            const imagesData = await rImages.json();
            setSessionImages(imagesData.available_images || []);
          } else {
            setSessionImages(summaryData.available_images || []);
          }
        } catch (e) {
          toast('Error loading session details or images', 'err');
          setSessionImages([]);
        }
      };

      useEffect(() => {
        if (activeTab === 'datasets' && datasetsService) {
          loadDatasets(datasetsService);
        }
      }, [activeTab, datasetsService]);

      const loadDatasets = async (service) => {
        setSelectedDataset(null);
        setDatasetPreview(null);
        try {
          const r = await fetch(`${API}/datasets/${service}`);
          if (!r.ok) throw new Error('Failed to fetch datasets');
          const data = await r.json();

          let datasetsList = [];
          if (service === 'classification_agent') {
            datasetsList = data || [];
          } else {
            datasetsList = data.datasets || [];
          }

          setDatasets(datasetsList);
        } catch {
          toast('Error loading datasets', 'err');
          setDatasets([]);
        }
      };

      const loadDatasetPreview = async (service, datasetName, fileName) => {
        setSelectedDataset({ datasetName, fileName });
        try {
          const r = await fetch(`${API}/datasets/${service}/${datasetName}/preview?file=${encodeURIComponent(fileName)}&n=20`);
          if (!r.ok) throw new Error('Failed to fetch dataset preview');
          const data = await r.json();
          setDatasetPreview(data);
        } catch {
          toast('Error loading dataset preview', 'err');
          setDatasetPreview(null);
        }
      };

      const backToDatasets = () => {
        setSelectedDataset(null);
        setDatasetPreview(null);
      };

      const backToSessions = () => {
        setSelectedSession(null);
        setSessionImages([]);
      };

      const getSwaggerUrl = (service) => {
        const port = service.port;
        if (!port) return null;

        // Exce√ß√£o: confiability_service usa /swagger-ui mesmo sendo fastapi
        if (service.name === 'confiability_service') {
          return `http://${SWAGGER_IP}:${port}/swagger-ui`;
        }
        
        // Para aplica√ß√µes Java (spring): /swagger-ui
        if (service.type === 'spring') {
          return `http://${SWAGGER_IP}:${port}/swagger-ui`;
        }
        
        // Para aplica√ß√µes Python (fastapi): /docs
        if (service.type === 'fastapi') {
          return `http://${SWAGGER_IP}:${port}/docs`;
        }

        return null;
      };

      const ServiceCard = ({ s }) => {
        const config = serviceConfigs[s.name] || { start: '[]', cwd: '' };
        const swaggerUrl = getSwaggerUrl(s);

        return (
          <div className="card" role="group" aria-label={`Service ${s.name}`}>
            <div className="service-header">
              <div>
                <div className="service-name">{s.name}</div>
                <span className={`badge ${s.running ? 'ok' : 'off'}`}>
                  {s.running ? 'RUNNING' : 'STOPPED'}
                </span>
              </div>
              <div className="meta" aria-label="Service info">
                <div>Port: {s.port || '-'}</div>
                <div>PID: {s.pid || '-'}</div>
                <div>Type: {s.type || '-'}</div>
              </div>
            </div>

            <div>
              <label htmlFor={`start-${s.name}`} style={{fontWeight: '600', fontSize: '0.9rem'}}>Start Command (JSON Array):</label>
              <textarea
                id={`start-${s.name}`}
                rows={3}
                className="input"
                value={config.start}
                onChange={e => onConfigChange(s.name, 'start', e.target.value)}
                spellCheck={false}
                aria-label={`Start command for ${s.name}`}
              />
            </div>

            <div style={{marginTop: '0.5rem'}}>
              <label htmlFor={`cwd-${s.name}`} style={{fontWeight: '600', fontSize: '0.9rem'}}>Working Directory (cwd):</label>
              <input
                id={`cwd-${s.name}`}
                type="text"
                className="input"
                value={config.cwd}
                onChange={e => onConfigChange(s.name, 'cwd', e.target.value)}
                placeholder="Optional"
                aria-label={`Working directory for ${s.name}`}
              />
            </div>

            <div className="service-footer">
              {swaggerUrl && (
                <a href={swaggerUrl} target="_blank" className="footer-link">
                  üìñ Swagger: {swaggerUrl}
                </a>
              )}
              {s.log_file && (
                <span className="footer-text">üìÑ Log: {s.log_file}</span>
              )}
            </div>

            <div className="row" style={{marginTop: '0.75rem'}}>
              <button className="btn-sm" onClick={() => startService(s.name)} disabled={s.running || loading}>Start</button>
              <button className="btn-sm" onClick={() => stopService(s.name)} disabled={!s.running || loading}>Stop</button>
              <button className="btn-sm" onClick={() => restartService(s.name)} disabled={loading}>Restart</button>
              <button className="btn-sm" onClick={() => viewLogs(s.name)}>Logs</button>
              <button className="btn-sm" onClick={() => saveServiceConfig(s.name)}>Save Config</button>
            </div>
          </div>
        );
      };

      return (
        <div className="app">
          <header className="header">
            <div className="brand"><h1>üîê Q-OPSEC Orchestrator</h1></div>
            <div className="actions">
              <button className="btn btn-green" onClick={startAll} disabled={loading}>‚ñ∂ Start All</button>
              <button className="btn btn-red" onClick={stopAll} disabled={loading}>‚ñ† Stop All</button>
              <button className="btn btn-ghost" onClick={fetchServices}>‚Üª Refresh</button>
              <button className="btn btn-ghost" onClick={() => window.open(API + '/docs', '_blank')}>üìñ Swagger</button>
            </div>
          </header>

          <nav className="tabs" role="tablist" aria-label="Tabs">
            <button
              className={`tab ${activeTab === 'services' ? 'active' : ''}`}
              onClick={() => setActiveTab('services')}
              role="tab"
              aria-selected={activeTab === 'services'}
            >
              Services
            </button>
            <button
              className={`tab ${activeTab === 'trace' ? 'active' : ''}`}
              onClick={() => setActiveTab('trace')}
              role="tab"
              aria-selected={activeTab === 'trace'}
            >
              Trace
            </button>
            <button
              className={`tab ${activeTab === 'flow' ? 'active' : ''}`}
              onClick={() => setActiveTab('flow')}
              role="tab"
              aria-selected={activeTab === 'flow'}
            >
              Flow
            </button>
            <button
              className={`tab ${activeTab === 'timeline' ? 'active' : ''}`}
              onClick={() => setActiveTab('timeline')}
              role="tab"
              aria-selected={activeTab === 'timeline'}
            >
              Timeline
            </button>
            <button
              className={`tab ${activeTab === 'active' ? 'active' : ''}`}
              onClick={loadActiveReqs}
              role="tab"
              aria-selected={activeTab === 'active'}
            >
              Active Requests
            </button>
            <button
              className={`tab ${activeTab === 'logs' ? 'active' : ''}`}
              onClick={() => setActiveTab('logs')}
              role="tab"
              aria-selected={activeTab === 'logs'}
            >
              Logs
            </button>
            <button
              className={`tab ${activeTab === 'metrics' ? 'active' : ''}`}
              onClick={() => setActiveTab('metrics')}
              role="tab"
              aria-selected={activeTab === 'metrics'}
            >
              Metrics
            </button>
            <button
              className={`tab ${activeTab === 'datasets' ? 'active' : ''}`}
              onClick={() => setActiveTab('datasets')}
              role="tab"
              aria-selected={activeTab === 'datasets'}
            >
              Datasets
            </button>
          </nav>

          <main className="container" role="tabpanel" aria-live="polite">
            {activeTab === 'services' && (
              <div className="grid" style={{gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '1rem'}}>
                {services.map(s => <ServiceCard key={s.name} s={s} />)}
              </div>
            )}

            {activeTab === 'metrics' && (
              <section>
                <div style={{marginBottom: '1rem', display: 'flex', gap: '1rem', flexWrap: 'wrap', alignItems: 'center'}}>
                  <label htmlFor="metrics-service-select" style={{fontWeight: '600'}}>Select Service:</label>
                  <select
                    id="metrics-service-select"
                    value={metricsService}
                    onChange={e => setMetricsService(e.target.value)}
                    style={{padding: '0.25rem 0.5rem', borderRadius: 6, borderColor: '#444', backgroundColor: '#111425', color: '#e5e7eb'}}
                  >
                    {SERVICES_WITH_METRICS.map(svc => (
                    <option key={svc} value={svc}>{svc}</option>
                    ))}
                  </select>
                </div>

                {!selectedSession && (
                  <>
                    <h2 style={{fontWeight: '700', fontSize: '1.25rem', marginBottom: '1rem'}}>Metric Sessions - {metricsService}</h2>
                    <div className="grid" style={{gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '1rem'}}>
                    {metricsSessions.length === 0 && <p>No sessions found.</p>}
                    {metricsSessions.map(session => (
                    <div
                    key={session.session_id}
                    className="card cursor-pointer hover:border-blue-500"
                    onClick={() => loadSessionDetail(metricsService, session)}
                    role="button"
                    tabIndex={0}
                    onKeyDown={e => e.key === 'Enter' && loadSessionDetail(metricsService, session)}
                    >
                    <div style={{fontWeight: '600'}}>{session.session_id}</div>
                    <div style={{fontSize: '0.85rem', color: '#9ca3af'}}>{new Date(session.timestamp).toLocaleString()}</div>
                    <div style={{fontSize: '0.85rem', marginTop: 4}}>Best model: {session.best_model_name}</div>
                    </div>
                    ))}
                    </div>
                  </>
                )}
                {selectedSession && (
                  <>
                    <button className="btn btn-ghost" style={{marginBottom: '1rem'}} onClick={backToSessions}>‚Üê Back to Sessions</button>
                    <h3 style={{fontWeight: '700', fontSize: '1.125rem', marginBottom: '1rem'}}>{selectedSession.session_id}</h3>
                    <ImageCarousel
                    images={sessionImages}
                    basePath={`/metrics/${metricsService}/sessions/${selectedSession.session_id}`}
                    />
                  </>
                )}
              </section>
            )}

            {activeTab === 'datasets' && (
              <section>
                <div style={{marginBottom: '1rem', display: 'flex', gap: '1rem', flexWrap: 'wrap', alignItems: 'center'}}>
                  <label htmlFor="datasets-service-select" style={{fontWeight: '600'}}>Select Service:</label>
                  <select
                    id="datasets-service-select"
                    value={datasetsService}
                    onChange={e => setDatasetsService(e.target.value)}
                    style={{padding: '0.25rem 0.5rem', borderRadius: 6, borderColor: '#444', backgroundColor: '#111425', color: '#e5e7eb'}}
                  >
                    {SERVICES_WITH_METRICS.map(svc => (
                    <option key={svc} value={svc}>{svc}</option>
                    ))}
                  </select>
                </div>

                {!selectedDataset && (
                  <>
                    <h2 style={{fontWeight: '700', fontSize: '1.25rem', marginBottom: '1rem'}}>Datasets - {datasetsService}</h2>
                    <div style={{display: 'flex', flexDirection: 'column', gap: '1rem'}}>
                    {datasets.length === 0 && <p>No datasets found.</p>}
                    {datasets.map(ds => (
                    <div key={ds.name} className="card">
                    <div style={{fontWeight: '600'}}>
                    {ds.name} {ds.type && <span style={{fontSize: '0.85rem', color: '#9ca3af'}}>({ds.type})</span>}
                    </div>
                    <div style={{fontSize: '0.85rem', marginTop: 4}}>
                    Files: {ds.files ? ds.files.length : 1}
                    </div>
                    {ds.files && ds.files.length > 0 && (
                    <ul style={{listStyleType: 'disc', paddingLeft: '1.25rem', marginTop: 8, maxHeight: 160, overflowY: 'auto'}}>
                    {ds.files.map(f => (
                    <li
                    key={f}
                    style={{cursor: 'pointer', color: '#3b82f6'}}
                    onClick={() => loadDatasetPreview(datasetsService, ds.name, f)}
                    tabIndex={0}
                    onKeyDown={e => e.key === 'Enter' && loadDatasetPreview(datasetsService, ds.name, f)}
                    >
                    {f}
                    </li>
                    ))}
                    </ul>
                    )}
                    </div>
                    ))}
                    </div>
                  </>
                )}
                {selectedDataset && (
                  <>
                    <button className="btn btn-ghost" style={{marginBottom: '1rem'}} onClick={backToDatasets}>‚Üê Back to Datasets</button>
                    <h3 style={{fontWeight: '700', fontSize: '1.125rem', marginBottom: '1rem'}}>
                    {selectedDataset.datasetName} / {selectedDataset.fileName}
                    </h3>
                    {datasetPreview && datasetPreview.rows && datasetPreview.rows.length > 0 ? (
                    <div style={{overflowX: 'auto', maxHeight: 400, border: '1px solid #444', borderRadius: 6}}>
                    <table style={{width: '100%', borderCollapse: 'collapse', fontSize: '0.85rem'}}>
                    <thead style={{backgroundColor: '#1e293b', position: 'sticky', top: 0}}>
                    <tr>
                    <th style={{padding: '0.5rem', border: '1px solid #444'}}>#</th>
                    <th style={{padding: '0.5rem', border: '1px solid #444'}}>Column</th>
                    <th style={{padding: '0.5rem', border: '1px solid #444'}}>Value</th>
                    </tr>
                    </thead>
                    <tbody>
                    {datasetPreview.rows.map((row, idx) =>
                    Object.entries(row).map(([col, val], i) => (
                    <tr key={`${idx}-${i}`} style={{backgroundColor: idx % 2 === 0 ? '#111827' : '#1f2937'}}>
                    <td style={{padding: '0.25rem 0.5rem', border: '1px solid #444', verticalAlign: 'top'}}>{idx + 1}</td>
                    <td style={{padding: '0.25rem 0.5rem', border: '1px solid #444', fontFamily: 'monospace', verticalAlign: 'top'}}>{col}</td>
                    <td style={{padding: '0.25rem 0.5rem', border: '1px solid #444', verticalAlign: 'top'}}>{String(val)}</td>
                    </tr>
                    ))
                    )}
                    </tbody>
                    </table>
                    </div>
                    ) : (
                    <p>No data to display.</p>
                    )}
                  </>
                )}
              </section>
            )}

            {activeTab === 'logs' && (
              <section>
                <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                  <h2 style={{fontWeight: '700', fontSize: '1.25rem'}}>Logs: {selectedService || 'Select a service'}</h2>
                  {selectedService && <button className="btn btn-ghost" onClick={() => viewLogs(selectedService)}>‚Üª Refresh</button>}
                </div>
                <div className="logs" role="log" aria-live="polite" tabIndex={0}>
                  {logs.length === 0 ? (
                    <p style={{color: '#9ca3af'}}>No lines to show.</p>
                  ) : logs.map((ln, i) => (
                    <div key={i} style={{whiteSpace: 'pre-wrap', fontFamily: 'monospace', fontSize: '0.85rem', borderBottom: '1px dashed #1d2240', padding: '0.25rem 0'}}>
                    {ln}
                    </div>
                  ))}
                </div>
              </section>
            )}

            {activeTab === 'trace' && (
              <section>
                <div style={{display: 'flex', gap: '0.75rem', marginBottom: '1rem', flexWrap: 'wrap'}}>
                  <input
                    className="input"
                    placeholder="Enter request_id (e.g. req_123)"
                    value={requestId}
                    onChange={e => setRequestId(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && doTrace()}
                    aria-label="Input for request_id"
                    style={{flexGrow: 1, minWidth: 200}}
                  />
                  <button className="btn btn-ghost" onClick={doTrace}>üîç Trace</button>
                </div>
                {traceData && (
                  <div className="panel" style={{marginTop:12}}>
                    <div style={{fontWeight: '700', marginBottom: 8}}>Trace for: {traceData.request_id}</div>
                    <div style={{color: '#9ca3af', marginBottom: 16}}>Status: {traceData.status} | Total matches: {traceData.total_matches || 0}</div>
                    {Object.entries(traceData.services || {}).map(([svc, data]) => (
                    <div key={svc} className="trace-service" tabIndex={0} aria-label={`Logs for service ${svc}`}>
                    <div style={{fontWeight: '700', color: '#3b82f6', marginBottom: 8}}>{svc} ({data.count} matches)</div>
                    {(data.matches || []).map((m, i) => (
                    <div key={i} className="trace-match">
                    <div style={{color: '#9ca3af'}}>Line {m.line_number} | {m.timestamp || 'No timestamp'}</div>
                    <div style={{marginTop: 6, fontFamily: 'monospace', whiteSpace: 'pre-wrap'}}>{m.line}</div>
                    {m.context && m.context.length > 0 && (
                    <details style={{marginTop: 6}}>
                    <summary>Show context</summary>
                    <div style={{fontFamily: 'monospace', whiteSpace: 'pre-wrap', marginTop: 6}}>{m.context.join('\n')}</div>
                    </details>
                    )}
                    </div>
                    ))}
                    </div>
                    ))}
                  </div>
                )}
              </section>
            )}

            {activeTab === 'flow' && (
              <section>
                <div style={{display: 'flex', gap: '0.75rem', marginBottom: '1rem', flexWrap: 'wrap'}}>
                  <input
                    className="input"
                    placeholder="Enter request_id"
                    value={requestId}
                    onChange={e => setRequestId(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && loadFlow()}
                    aria-label="Input for flow request_id"
                    style={{flexGrow: 1, minWidth: 200}}
                  />
                  <button className="btn btn-ghost" onClick={loadFlow}>üìä View Flow</button>
                </div>
                {flowData && (
                  <div className="panel">
                    <div style={{fontWeight: '700', marginBottom: 8}}>Flow for: {flowData.request_id}</div>
                    <div style={{color: '#9ca3af', marginBottom: 16}}>Current step: {flowData.current_step}/{flowData.total_steps}</div>
                    <div>
                    {(flowData.flow || []).map(step => (
                    <div key={step.step} className="flow-step" tabIndex={0} aria-label={`Step ${step.step} of service ${step.service}`}>
                    <div className="ball">{step.step}</div>
                    <div style={{flex: 1}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                    <div style={{fontWeight: '700'}}>{step.service}</div>
                    <span className={`chip ${
                    step.status === 'processed' ? 'ok' :
                    step.status === 'error' ? 'err' : 'wait'
                    }`}>
                    {step.status === 'processed' ? 'Processed' : step.status === 'error' ? 'Error' : 'Pending'}
                    </span>
                    </div>
                    <div style={{marginTop: 4, fontSize: '0.85rem', color: '#9ca3af'}}>{step.endpoint}</div>
                    {step.last_seen && <div style={{marginTop: 4, fontSize: '0.85rem', color: '#9ca3af'}}>Last seen: {step.last_seen}</div>}
                    {step.error && <div style={{marginTop: 6, fontFamily: 'monospace', color: '#ef4444'}}>{step.error}</div>}
                    </div>
                    </div>
                    ))}
                    </div>
                  </div>
                )}
              </section>
            )}

            {activeTab === 'timeline' && (
              <section>
                <div style={{display: 'flex', gap: '0.75rem', marginBottom: '1rem', flexWrap: 'wrap'}}>
                  <input
                    className="input"
                    placeholder="Enter request_id"
                    value={requestId}
                    onChange={e => setRequestId(e.target.value)}
                    onKeyDown={e => e.key === 'Enter' && loadTimeline()}
                    aria-label="Input for timeline request_id"
                    style={{flexGrow: 1, minWidth: 200}}
                  />
                  <button className="btn btn-ghost" onClick={loadTimeline}>‚è± View Timeline</button>
                </div>
                {timelineData && (
                  <div className="panel">
                    <div style={{fontWeight: '700', marginBottom: 8}}>Timeline for: {timelineData.request_id}</div>
                    <div style={{color: '#9ca3af', marginBottom: 16}}>Events: {timelineData.total_events}</div>
                    <div>
                    {(timelineData.timeline || []).map((ev, i) => (
                    <div key={i} className="timeline-item" tabIndex={0} aria-label={`Event ${i + 1} of service ${ev.service}`}>
                    <div style={{color: '#9ca3af', fontFamily: 'monospace'}}>{ev.timestamp}</div>
                    <div style={{color: '#3b82f6', fontWeight: '700'}}>{ev.service}</div>
                    <div style={{fontFamily: 'monospace'}}>{ev.line}</div>
                    </div>
                    ))}
                    </div>
                  </div>
                )}
              </section>
            )}

            {activeTab === 'active' && (
              <section>
                <h2 style={{fontWeight: '700', fontSize: '1.25rem', marginBottom: '1rem'}}>Active Request IDs ({activeRequests.length})</h2>
                <div style={{display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(220px, 1fr))', gap: '1rem'}}>
                  {activeRequests.length === 0 && <p>No active requests found.</p>}
                  {activeRequests.map(id => (
                    <button
                    key={id}
                    className="card cursor-pointer"
                    onClick={() => { setRequestId(id); setActiveTab('trace'); doTrace(); }}
                    tabIndex={0}
                    aria-label={`Active request ${id}`}
                    >
                    <div style={{fontFamily: 'monospace'}}>{id}</div>
                    </button>
                  ))}
                </div>
              </section>
            )}
          </main>

          {notif && (
            <div className={`notif ${notif.type === 'ok' ? 'ok' : 'err'}`} role="alert" aria-live="assertive">
              {notif.msg}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>